<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-07-14">

<title>Annealed Importance Sampling – Andrew G. Roberts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../headshot_photo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Andrew G. Roberts</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/arob5/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Annealed Importance Sampling</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">MCMC</div>
                <div class="quarto-category">Sampling</div>
                <div class="quarto-category">Computational Statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 14, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-and-derivation" id="toc-setup-and-derivation" class="nav-link active" data-scroll-target="#setup-and-derivation"><span class="header-section-number">1</span> Setup and Derivation</a>
  <ul class="collapse">
  <li><a href="#bridging-distributions" id="toc-bridging-distributions" class="nav-link" data-scroll-target="#bridging-distributions"><span class="header-section-number">1.1</span> Bridging Distributions</a></li>
  <li><a href="#markov-kernels" id="toc-markov-kernels" class="nav-link" data-scroll-target="#markov-kernels"><span class="header-section-number">1.2</span> Markov Kernels</a></li>
  <li><a href="#extended-state-space" id="toc-extended-state-space" class="nav-link" data-scroll-target="#extended-state-space"><span class="header-section-number">1.3</span> Extended State Space</a></li>
  <li><a href="#importance-weights" id="toc-importance-weights" class="nav-link" data-scroll-target="#importance-weights"><span class="header-section-number">1.4</span> Importance Weights</a></li>
  <li><a href="#algorithm" id="toc-algorithm" class="nav-link" data-scroll-target="#algorithm"><span class="header-section-number">1.5</span> Algorithm</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In this post we walk through the annealed importance sampling (AIS) scheme introduced in the classic paper <span class="citation" data-cites="Neal">Neal (<a href="#ref-Neal" role="doc-biblioref">1998</a>)</span>. The algorithm seeks to improve upon standard IS by incorporating Markov chain Monte Carlo (MCMC) updates, and is widely used for estimating intractable expectations and normalizing constants. While I highly recommend reading Neal’s original paper, my presentation here leans towards more recent perspectives. My notation is most similar to <span class="citation" data-cites="Doucet">Doucet et al. (<a href="#ref-Doucet" role="doc-biblioref">2022</a>)</span>.</p>
<section id="setup-and-derivation" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Setup and Derivation</h1>
<p>Consider a target distribution <span id="eq-target"><span class="math display">\[
\begin{align}
&amp;\pi(x) = \frac{f(x)}{Z}, &amp;&amp;Z = \int f(x) dx
\end{align}
\tag{1}\]</span></span> such that <span class="math inline">\(f(x)\)</span> can be evaluated at any input <span class="math inline">\(x \in \mathbb{R}^d\)</span>. Two common goals are to estimate expectations with respect to <span class="math inline">\(\pi\)</span> and to estimate the intractable normalizing constant <span class="math inline">\(Z\)</span>. As with standard IS, AIS addresses these problems by returning weighted samples <span class="math inline">\((x^{(n)}, w^{(n)})\)</span>, with the weights <span class="math inline">\(w^{(n)}\)</span> constructed to produce unbiased estimates of the quantities of interest.</p>
<section id="bridging-distributions" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="bridging-distributions"><span class="header-section-number">1.1</span> Bridging Distributions</h2>
<p>The idea underlying annealed IS is to improve an initial proposal via a sequence of updates that move the proposal closer to <span class="math inline">\(\pi\)</span>. An initial “simple” distribution is slowly <em>annealed</em> towards the intractable target distribution. Let <span class="math inline">\((\pi_k)_{k=0}^{K}\)</span> denote the sequence of intermediate distributions <span class="math inline">\(\pi_k(x) = f_k(x)/Z_k\)</span>. In this post, we will consider <span class="math inline">\(\pi_0\)</span> to be a simple distribution from which independent samples can be drawn. The final distribution <span class="math inline">\(\pi_K = \pi\)</span> is the target, meaning the intermediate distributions bridge from the simple distribution to <span class="math inline">\(\pi\)</span>. The canonical choice of bridging distributions is the geometric path, defined by the geometric averages <span id="eq-geometric-path"><span class="math display">\[
\begin{align}
&amp;f_k(x) := f_0(x)^{1-\beta_k} f(x)^{\beta_k},
&amp;&amp;0 = \beta_0 &lt; \beta_1 &lt; \cdots &lt; \beta_K = 1.
\end{align}
\tag{2}\]</span></span></p>
<div class="callout callout-style-default callout-note callout-titled" title="Remark">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Remark
</div>
</div>
<div class="callout-body-container callout-body">
<p>If <span class="math inline">\(\pi_0\)</span> is a (potentially improper) uniform distribution, then the geometric path simplifies to <span class="math inline">\(f_k(x) := f(x)^{\beta_k}\)</span>. This is a common path used in simulated annealing algorithms for optimizing <span class="math inline">\(f\)</span>, motivating the word “annealed” in annealed importance sampling.</p>
</div>
</div>
<p>As we will see below, we require the bridging distributions to satisfy <span id="eq-abs-cont"><span class="math display">\[
f_k(x) = 0 \implies f_{k+1}(x) = 0.
\tag{3}\]</span></span> In other words, the supports of the distributions cannot be growing as <span class="math inline">\(\pi_0\)</span> evolves to <span class="math inline">\(\pi_K\)</span>. This assumption is often denoted by <span class="math inline">\(\pi_K \ll \pi_{K-1} \ll \cdots \ll \pi_0\)</span>, where <span class="math inline">\(\pi_{k+1} \ll \pi_{k}\)</span> is defined by <a href="#eq-abs-cont" class="quarto-xref">Equation&nbsp;3</a> and read “<span class="math inline">\(\pi_{k+1}\)</span> is absolutely continuous with respect to <span class="math inline">\(\pi_{k}\)</span>”.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Remark">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Remark
</div>
</div>
<div class="callout-body-container callout-body">
<p>In some treatments (including Neal’s original paper), the sequence of distributions is defined in the reverse order, such that <span class="math inline">\(\pi_K\)</span> is the simple distribution and <span class="math inline">\(\pi_0 = \pi\)</span>. This is mostly a matter of taste. As we will see, the reversed sequence will still become relevant here.</p>
</div>
</div>
</section>
<section id="markov-kernels" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="markov-kernels"><span class="header-section-number">1.2</span> Markov Kernels</h2>
<p>If we could sample directly from the <span class="math inline">\(\pi_k\)</span> then the problem would already be solved, since <span class="math inline">\(\pi_K\)</span> is precisely the distribution from which we hope to sample. Given that this is not possible, we will instead try to approximately track the intermediate distributions via Markov chain iterations. The importance weights will ultimately correct for the fact that we are not exactly tracking the distributions. Let <span class="math inline">\((F_k)_{k=1}^{K}\)</span> be a collection of Markov kernels such that <span class="math inline">\(F_k\)</span> is <span class="math inline">\(\pi_k\)</span>-invariant. In particular, the target <span class="math inline">\(\pi\)</span> is the stationary distribution of <span class="math inline">\(F_K\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Remark">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Remark
</div>
</div>
<div class="callout-body-container callout-body">
<p>In general, the final Markov kernel <span class="math inline">\(F_K\)</span> need not be <span class="math inline">\(\pi\)</span>-invariant, a fact that will emerge as we derive the algorithm. There is actually no <span class="math inline">\(F_K\)</span> is Neal’s original formulation. However, in most applications I am aware of it is included.</p>
</div>
</div>
<p>An IS proposal can then be generated via <span id="eq-prop-gen"><span class="math display">\[
\begin{align}
&amp;x_0 \sim \pi_0, &amp;&amp;x_k \sim F_k(x_{k-1}, \cdot), \qquad k = 1, 2, \dots, K.
\end{align}
\tag{4}\]</span></span> The resulting vector <span class="math inline">\(x_{0:K} := (x_0, \dots, x_K)\)</span> has joint distribution <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <span id="eq-prop-dens"><span class="math display">\[
\begin{align}
&amp;q(x_{0:K}) := \frac{f^q(x_{0:K})}{Z_0}
&amp;&amp;f^q(x_{0:K}) := f_0(x_0)\prod_{k=1}^{K} F_k(x_{k-1}, x_k).
\end{align}
\tag{5}\]</span></span> Letting <span class="math inline">\(q_k\)</span> denote the <span class="math inline">\(k^{\text{th}}\)</span> univariate marginal of <span class="math inline">\(q\)</span>, we see that <span id="eq-prop-dens-marg"><span class="math display">\[
q_K(x_K) := \int \pi_0(x_0)\prod_{k=1}^{K} F_k(x_{k-1}, x_k) \ dx_{0:K-1}
\tag{6}\]</span></span> is the marginal distribution of <span class="math inline">\(x_K\)</span>. This final marginal can be viewed as the best approximation to <span class="math inline">\(\pi\)</span>. If we view the final entry <span class="math inline">\(x_K\)</span> of <span class="math inline">\(x_{0:K}\)</span> as a standard IS proposal, then we would have to compute the importance weight <span class="math inline">\(f(x_K)/f^q_K(x_K)\)</span>. In light of <a href="#eq-prop-dens-marg" class="quarto-xref">Equation&nbsp;6</a>, the denominator is typically intractable, and we appear out of luck.</p>
</section>
<section id="extended-state-space" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="extended-state-space"><span class="header-section-number">1.3</span> Extended State Space</h2>
<p>A clever way around this issue is to view <a href="#eq-prop-gen" class="quarto-xref">Equation&nbsp;4</a> as an IS proposal in an extended state space over <span class="math inline">\((x_0, \dots, x_K)\)</span>. The joint density <span class="math inline">\(q_K(x_K)\)</span> in <a href="#eq-prop-dens-marg" class="quarto-xref">Equation&nbsp;6</a> is thus the associated proposal density. The question now becomes how to define the target distribution <span class="math inline">\(p(x_{0:K}) = f^p(x_{0:K})/Z^p\)</span> over the extended state space. Most importantly, we will define the target such that it admits <span class="math inline">\(\pi\)</span> as a marginal. This implies that if we formulate a valid IS algorithm in the extended state space, then we will have solved the original problem by simply extracting the relevant component from samples of the extended state. We will also choose <span class="math inline">\(p\)</span> to have a specific Markov structure that leads <span class="math inline">\(f^p(x_{0:K})/f^q(x_{0:K})\)</span> to have a convenient, computable form. To this end, consider <span id="eq-target-ext"><span class="math display">\[
p(x_{0:K}) := \frac{1}{Z^p} f(x_K) \prod_{k=0}^{K-1} R_k(x_{k+1}, x_k),
\tag{7}\]</span></span> which admits <span class="math inline">\(\pi\)</span> as the <span class="math inline">\(K^{\text{th}}\)</span> marginal. Here, <span class="math inline">\(R_k\)</span> is another Markov kernel which is the reversal of <span class="math inline">\(F_k\)</span>. The reversed Markov kernel (with respect to invariant distribution <span class="math inline">\(\pi_k\)</span>) is defined by the identity <span id="eq-rev-kernel-id"><span class="math display">\[
\pi_k(x)F_k(x,x^\prime) = \pi_k(x^\prime) R_k(x^\prime, x)
\tag{8}\]</span></span> Rearranging <a href="#eq-rev-kernel-id" class="quarto-xref">Equation&nbsp;8</a>, we obtain the explicit expression <span id="eq-rev-kernel"><span class="math display">\[
R_k(x^\prime, x)
= \frac{\pi_k(x)}{\pi_k(x^\prime)} F_k(x,x^\prime)
= \frac{f_k(x)}{f_k(x^\prime)} F_k(x,x^\prime).
\tag{9}\]</span></span> The kernel <span class="math inline">\(R_k\)</span> defines a valid Markov chain that preserves the stationary distribution <span class="math inline">\(\pi_k\)</span> when run backwards in time.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Proof">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Proof
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Putting aside measure-theoretic technicalities, we simply verify that <span class="math inline">\(R_k(x^\prime, \cdot)\)</span> defines a valid probability distribution for each <span class="math inline">\(x^\prime\)</span>. This follows from <span class="math display">\[
\begin{align}
\int R_k(x^\prime, x) dx
&amp;= \int \frac{\pi_k(x)}{\pi_k(x^\prime)} F_k(x, x^\prime) dx \\
&amp;= \frac{1}{\pi_k(x^\prime)} \int \pi_k(x) F_k(x, x^\prime) dx \\
&amp;= \frac{\pi_k(x^\prime)}{\pi_k(x^\prime)} \\
&amp;= 1,
\end{align}
\]</span> where the penultimate equality uses the fact that <span class="math inline">\(F_k\)</span> is <span class="math inline">\(\pi_k\)</span>-invariant. To show that <span class="math inline">\(R_k\)</span> is also <span class="math inline">\(\pi_k\)</span>-invariant, see that <span class="math display">\[
\begin{align}
\int \pi_k(x^\prime) R_k(x^\prime, x) dx^\prime
&amp;= \int \pi_k(x^\prime) \frac{\pi_k(x)}{\pi_k(x^\prime)} F_k(x, x^\prime) dx^\prime \\
&amp;= \int \pi_k(x) R_k(x, x^\prime) dx^\prime \\
&amp;= \pi_k(x) \int R_k(x, x^\prime) dx^\prime \\
&amp;= \pi_k(x),
\end{align}
\]</span> where the final equality uses the fact that <span class="math inline">\(R_k\)</span> is a Markov kernel.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Remark">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Remark
</div>
</div>
<div class="callout-body-container callout-body">
<p>Certain Markov kernels (e.g., Metropolis-Hastings kernels) are explicitly constructed to satisfy <span class="math inline">\(F_k = R_k\)</span> (the detailed balance condition). Kernels that are not in detailed balance with <span class="math inline">\(\pi_k\)</span> require the re-weighting <span class="math inline">\(\pi_k(x)/\pi_k(x^\prime)\)</span> in <a href="#eq-rev-kernel-id" class="quarto-xref">Equation&nbsp;8</a> to construct a kernel that preserves the stationary distribution when run in reverse.</p>
</div>
</div>
</section>
<section id="importance-weights" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="importance-weights"><span class="header-section-number">1.4</span> Importance Weights</h2>
<p>The preceding sections define the target <span class="math inline">\(p\)</span> and proposal <span class="math inline">\(q\)</span> on the extended state space. The IS algorithm in the extended space proceeds via the steps:</p>
<ol type="1">
<li>Sample <span class="math inline">\(x_{0:K} \sim q\)</span>.</li>
<li>Return <span class="math inline">\((x_{0:K},w(x_{0:K}))\)</span>, where <span class="math inline">\(w(x_{0:K}) := f^p(x_{0:K})/f^q(x_{0:K})\)</span> is the importance weight.</li>
</ol>
<p>This algorithm will only be useful if we can easily compute the importance weight. The Markov structure in <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> yields a very convenient form for <span class="math inline">\(w\)</span>. To see this, we start by applying <a href="#eq-rev-kernel" class="quarto-xref">Equation&nbsp;9</a> to write <span class="math inline">\(f^p\)</span> as <span id="eq-rev-joint-rewrite"><span class="math display">\[
f^p(x_{0:K}) = f^q(x_{0:K}) \frac{f(x_K)}{f_0(x_0)} \prod_{k=1}^{K} \frac{f_k(x_{k-1})}{f_k(x_k)}
\tag{10}\]</span></span></p>
<div class="callout callout-style-default callout-note callout-titled" title="Derivation">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Derivation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math display">\[
\begin{align}
f^p(x_{0:K})
&amp;= f(x_K) \prod_{k=1}^{K} R_k(x_k, x_{k-1}) \\
&amp;= f(x_K) \prod_{k=1}^{K} \frac{f_k(x_{k-1})}{f_k(x_k)} F_k(x_{k-1},x_k) \\
&amp;= \left[f_0(x_0) \prod_{k=1}^{K} F_k(x_{k-1},x_k) \right] \cdot
\frac{f(x_K)}{f_0(x_0)} \prod_{k=1}^{K} \frac{f_k(x_{k-1})}{f_k(x_k)} \\
&amp;= f^q(x_{0:K}) \frac{f(x_K)}{f_0(x_0)} \prod_{k=1}^{K} \frac{f_k(x_{k-1})}{f_k(x_k)}
\end{align}
\]</span></p>
</div>
</div>
</div>
<p>The importance weight thus simplifies to <span id="eq-importance-weight"><span class="math display">\[
w(x_{0:K}) = \frac{f^p(x_{0:K})}{f^q(x_{0:K})} = \prod_{k=0}^{K-1} \frac{f_{k+1}(x_k)}{f_k(x_k)} .
\tag{11}\]</span></span></p>
<div class="callout callout-style-default callout-note callout-titled" title="Derivation">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Derivation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Using <a href="#eq-rev-joint-rewrite" class="quarto-xref">Equation&nbsp;10</a>, we have <span class="math display">\[
\begin{align}
\frac{f^p(x_{0:K})}{f^q(x_{0:K})}
&amp;= \frac{f(x_K)}{f_0(x_0)} \prod_{k=1}^{K} \frac{f_k(x_{k-1})}{f_k(x_k)}
\end{align}
\]</span></p>
</div>
</div>
</div>
<p>We see in <a href="#eq-importance-weight" class="quarto-xref">Equation&nbsp;11</a> the precise reason why the absolute continuity assumption in <a href="#eq-abs-cont" class="quarto-xref">Equation&nbsp;3</a> is required. This assumptions avoids dividing by zero in density ratios, ensuring the importance weight is well-defined.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Remark">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Remark
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice that the final value <span class="math inline">\(x_K\)</span> from the proposal <span class="math inline">\(x_{0:K} \sim q\)</span> does not appear in the importance weight in <a href="#eq-importance-weight" class="quarto-xref">Equation&nbsp;11</a>. This was hinted at by an earlier remark, which claimed that the algorithm would still be valid in the absence of the last kernel <span class="math inline">\(F_K\)</span>. Implicitly, this kernel contributes the term <span class="math inline">\(f_K(x_K)/f_K(x_K)\)</span> in <a href="#eq-importance-weight" class="quarto-xref">Equation&nbsp;11</a>.</p>
</div>
</div>
</section>
<section id="algorithm" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="algorithm"><span class="header-section-number">1.5</span> Algorithm</h2>
<p>The core of the AIS algorithm is the generation of independent weighted samples <span class="math inline">\((x^{(n)}_{0:K}, w(x_{0:K}^{(n)}))\)</span>. We discuss the use of these samples for estimating expectations and normalizing constants in the next section. Here, we summarize the above derivations in an algorithm. The procedure simply requires sampling <span class="math inline">\(x_{0:K} \sim q\)</span> and then computing the weight in <a href="#eq-importance-weight" class="quarto-xref">Equation&nbsp;11</a>. As seen below, this can be done in an online fashion, which shoes that AIS can be viewed as alternating between MCMC steps and IS updates. Note that the logarithm actually returns the logarithm of the importance weight for numerical stability.</p>
<div id="alg-single-step-eki" class="algo-box algorithm">
<p><strong>Algorithm 1: Calculate AIS weighted sample</strong> <span class="math display">\[
\begin{array}{ll}
&amp;\textbf{Input:} &amp;&amp; (f_k)_{k=1}^K, \ (F_k)_{k=1}^K \\
&amp; \textbf{Output:} &amp;&amp; \text{Weighted sample } \{x_{0:K}, \log w(x_{0:K})\} \\
\hline \\[0.1em]
&amp; x_0 \sim \pi_0 \\
&amp; \ell_w \gets 0 \\
&amp; \textbf{for } k = 1 \textbf{ to } K \textbf{ do} \\
&amp; \quad \ell_w \gets \ell_w + \log f_k(x_{k-1}) - \log f_{k-1}(x_{k-1}) \\
&amp; \quad x_k \sim F_{k+1}(x_{k-1}, \cdot) \\
&amp; \textbf{end for} \\[0.1em]
&amp; x \gets (x_0, \dots, x_K) \\
&amp; \textbf{Return:} \qquad (x, \ell_w)
\end{array}
\]</span></p>
</div>




</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Doucet" class="csl-entry" role="listitem">
Doucet, Arnaud, Will Grathwohl, Alexander G. D. G. Matthews, and Heiko Strathmann. 2022. <span>“Score-Based Diffusion Meets Annealed Importance Sampling.”</span> <a href="https://arxiv.org/abs/2208.07698">https://arxiv.org/abs/2208.07698</a>.
</div>
<div id="ref-Neal" class="csl-entry" role="listitem">
Neal, Radford M. 1998. <span>“Annealed Importance Sampling.”</span> <a href="https://arxiv.org/abs/physics/9803008">https://arxiv.org/abs/physics/9803008</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Throughout this post we will assume all distributions and Markov kernels admit densities with respect to some common dominating measure (typically the Lebesgue measure).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/arob5\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="arob5/arob5.github.io" issue-term="title" theme="body-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2025 Andrew G. Roberts ∙ Made with <a href="https://quarto.org">Quarto</a></p>
</div>   
    <div class="nav-footer-center">
<p><a class="link-dark me-1" href="https://github.com/arob5" title="github" target="_blank" rel="noopener"><iconify-icon role="img" inline="" icon="fa6-brands:github" aria-label="Icon github from fa6-brands Iconify.design set." title="Icon github from fa6-brands Iconify.design set."></iconify-icon></a> <a class="link-dark me-1" href="https://orcid.org/0009-0002-4274-7914" title="orcid" target="_blank" rel="noopener"><iconify-icon role="img" inline="" icon="fa6-brands:orcid" aria-label="Icon orcid from fa6-brands Iconify.design set." title="Icon orcid from fa6-brands Iconify.design set."></iconify-icon></a> <a class="link-dark me-1" href="https://scholar.google.com/citations?user=E2erpCwAAAAJ&amp;hl=en" title="Google Scholar" target="_blank" rel="noopener"><iconify-icon role="img" inline="" icon="fa6-brands:google-scholar" aria-label="Icon google-scholar from fa6-brands Iconify.design set." title="Icon google-scholar from fa6-brands Iconify.design set."></iconify-icon></a> <a class="link-dark me-1" href="https://linkedin.com/in/andrew-roberts5" title="LinkedIn" target="_blank" rel="noopener"><iconify-icon role="img" inline="" icon="fa6-brands:linkedin" aria-label="Icon linkedin from fa6-brands Iconify.design set." title="Icon linkedin from fa6-brands Iconify.design set."></iconify-icon></a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>